{% extends 'core/base.html' %}
{% load static %}

{% block title %}Checkout - Packaxis{% endblock %}

{% block extra_css %}
<style>
    .checkout-page {
        padding-top: 0;
        padding-bottom: 5rem;
        min-height: auto;
        background: #ffffff;
    }
    
    /* Checkout Hero */
    .checkout-hero {
        background: linear-gradient(180deg, #292808 0%, #1f1e06 100%);
        padding: 140px 0 60px;
        position: relative;
        overflow: hidden;
    }
    
    .checkout-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -30%;
        width: 80%;
        height: 200%;
        background: radial-gradient(circle, rgba(212, 255, 158, 0.06) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .checkout-hero::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -20%;
        width: 60%;
        height: 150%;
        background: radial-gradient(circle, rgba(212, 255, 158, 0.04) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .checkout-hero .container {
        position: relative;
        z-index: 2;
    }
    
    .checkout-hero-content {
        text-align: center;
    }
    
    .checkout-hero .breadcrumb {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }
    
    .checkout-hero .breadcrumb a {
        color: #d4ff9e;
        text-decoration: none;
        transition: opacity 0.3s ease;
    }
    
    .checkout-hero .breadcrumb a:hover {
        opacity: 0.8;
    }
    
    .checkout-hero .breadcrumb .separator {
        color: rgba(255,255,255,0.4);
    }
    
    .checkout-hero .breadcrumb .current {
        color: rgba(255,255,255,0.7);
    }
    
    .checkout-hero h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: #ffffff;
        margin-bottom: 0.5rem;
    }
    
    .checkout-hero h1 span {
        color: #d4ff9e;
    }
    
    .checkout-hero p {
        color: rgba(255,255,255,0.7);
        font-size: 1rem;
    }
    
    .checkout-main {
        padding: 3rem 0;
        background: linear-gradient(180deg, #ffffff 0%, #fafaf2 100%);
    }
    
    .checkout-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 1.25rem;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #666;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1.5rem;
        transition: color 0.3s ease;
    }
    
    .back-link:hover {
        color: #292808;
    }
    
    .back-link svg {
        width: 18px;
        height: 18px;
    }
    
    /* Progress Steps */
    .checkout-progress {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0;
        margin-bottom: 2.5rem;
        padding: 0 1rem;
    }
    
    .progress-step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #999;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .progress-step.active {
        color: #292808;
    }
    
    .progress-step.done {
        color: #292808;
    }
    
    .step-num {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e5e5;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .progress-step.active .step-num {
        background: #292808;
        color: #d4ff9e;
        box-shadow: 0 4px 15px rgba(47, 46, 12, 0.2);
    }
    
    .progress-step.done .step-num {
        background: #d4ff9e;
        color: #292808;
    }
    
    .progress-line {
        width: 60px;
        height: 3px;
        background: #e5e5e5;
        margin: 0 0.75rem;
        border-radius: 2px;
    }
    
    .progress-line.done {
        background: linear-gradient(90deg, #d4ff9e, #a8e65c);
    }
    
    @media (max-width: 768px) {
        .checkout-hero {
            padding: 120px 0 50px;
        }
        
        .checkout-hero h1 {
            font-size: 2rem;
        }
    }
    
    @media (max-width: 600px) {
        .progress-step span:not(.step-num) {
            display: none;
        }
        .progress-line {
            width: 40px;
        }
    }
    
    /* Layout */
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        align-items: start;
    }
    
    @media (max-width: 900px) {
        .checkout-grid {
            grid-template-columns: 1fr;
        }
        
        .order-panel {
            order: -1;
        }
    }
    
    /* Form Sections */
    .form-section {
        background: white;
        border-radius: 20px;
        padding: 1.75rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
    }
    
    .form-section:hover {
        box-shadow: 0 8px 40px rgba(41, 40, 8, 0.1);
    }
    
    .shipping-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .shipping-option {
        position: relative;
        display: flex;
        gap: 1rem;
        padding: 1.25rem;
        border: 2px solid #e5e5e5;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .shipping-option:hover {
        border-color: #d4ff9e;
        background: #ffffff;
        box-shadow: 0 6px 25px rgba(41, 40, 8, 0.08);
    }

    .shipping-option.active {
        border-color: #292808;
        background: #ffffff;
        box-shadow: 0 12px 35px rgba(41, 40, 8, 0.12);
    }

    .shipping-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .shipping-option-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 600;
        background: #d4ff9e;
        color: #292808;
    }

    .shipping-option-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .shipping-option h4 {
        font-size: 1rem;
        font-weight: 700;
        color: #292808;
        margin: 0;
    }

    .shipping-option .shipping-price {
        font-weight: 700;
        color: #292808;
        font-size: 1rem;
    }

    .shipping-option .shipping-meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        color: #666;
        font-size: 0.85rem;
    }

    .shipping-option .selected-indicator {
        position: absolute;
        inset: 12px;
        border-radius: 12px;
        pointer-events: none;
    }

    .shipping-option.active .selected-indicator {
        border: 2px solid rgba(212, 255, 158, 0.8);
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }
    
    .section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #292808;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #d4ff9e 0%, #a8e65c 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .section-icon svg {
        width: 20px;
        height: 20px;
        stroke: #292808;
    }
    
    /* Form Fields */
    .field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .field-row.single {
        grid-template-columns: 1fr;
    }
    
    .field-row.triple {
        grid-template-columns: 2fr 1fr 1fr;
    }
    
    @media (max-width: 600px) {
        .field-row,
        .field-row.triple {
            grid-template-columns: 1fr;
        }
    }
    
    .field {
        display: flex;
        flex-direction: column;
        position: relative;
    }
    
    .field label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .field label .req {
        color: #dc3545;
        font-weight: 700;
    }
    
    .field label .optional {
        color: #888;
        font-weight: 400;
        font-size: 0.75rem;
    }
    
    .field input,
    .field select,
    .field textarea {
        padding: 0.875rem 1rem;
        border: 2px solid #e5e5e5;
        border-radius: 12px;
        font-size: 0.9375rem;
        transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        width: 100%;
        background: #fafafa;
        color: #292808;
    }
    
    .field input:hover,
    .field select:hover,
    .field textarea:hover {
        border-color: #ccc;
        background: white;
    }
    
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
        outline: none;
        border-color: #d4ff9e;
        background: white;
        box-shadow: 0 0 0 4px rgba(212, 255, 158, 0.25);
    }
    
    .field input.error,
    .field select.error {
        border-color: #dc3545;
        background: #fff5f5;
    }
    
    .field input.error:focus,
    .field select.error:focus {
        box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.15);
    }
    
    .field input::placeholder {
        color: #999;
    }
    
    .field textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .field-hint {
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.375rem;
    }
    
    .field-error {
        font-size: 0.75rem;
        color: #dc3545;
        margin-top: 0.375rem;
        display: none;
    }
    
    .field.has-error .field-error {
        display: block;
    }
    
    /* Address Autocomplete Styles */
    .address-input-wrapper {
        position: relative;
    }
    
    .address-input-wrapper input {
        padding-right: 40px;
    }
    
    .address-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
    }
    
    /* Billing Address Toggle */
    .billing-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: #f8f8f8;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .billing-toggle:hover {
        background: #f0f0f0;
    }
    
    .billing-toggle input[type="checkbox"] {
        display: none;
    }
    
    .toggle-switch {
        width: 44px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        position: relative;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    .billing-toggle input:checked + .toggle-switch {
        background: #d4ff9e;
    }
    
    .billing-toggle input:checked + .toggle-switch::after {
        left: 22px;
    }
    
    .toggle-text {
        font-size: 0.9rem;
        font-weight: 500;
        color: #333;
    }
    
    .toggle-text span {
        display: block;
        font-size: 0.75rem;
        color: #888;
        font-weight: 400;
        margin-top: 2px;
    }
    
    .billing-fields {
        display: none;
        padding-top: 0.5rem;
        animation: slideDown 0.3s ease;
    }
    
    .billing-fields.show {
        display: block;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Payment Notice */
    .payment-info {
        background: linear-gradient(135deg, #fef9e7 0%, #fff8e1 100%);
        border: 1px solid #f9e79f;
        border-radius: 12px;
        padding: 1.25rem;
        margin-top: 1rem;
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .payment-info-icon {
        width: 40px;
        height: 40px;
        background: #f9e79f;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .payment-info-icon svg {
        width: 20px;
        height: 20px;
        stroke: #b7950b;
    }
    
    .payment-info-content h4 {
        font-size: 0.9rem;
        font-weight: 700;
        color: #7d6608;
        margin-bottom: 0.375rem;
    }
    
    .payment-info-content p {
        font-size: 0.8125rem;
        color: #9a7d0a;
        line-height: 1.6;
        margin: 0;
    }
    
    /* Payment Notice - Manual Payment Section */
    .payment-info-section {
        margin-bottom: 0;
    }
    
    .payment-notice {
        background: linear-gradient(135deg, #f0fff4 0%, #e6ffec 100%);
        border: 1px solid #d4ff9e;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .payment-notice .notice-icon {
        width: 44px;
        height: 44px;
        background: #d4ff9e;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .payment-notice .notice-icon svg {
        width: 22px;
        height: 22px;
        stroke: #292808;
    }
    
    .payment-notice .notice-content strong {
        display: block;
        font-size: 1rem;
        font-weight: 700;
        color: #292808;
        margin-bottom: 0.5rem;
    }
    
    .payment-notice .notice-content p {
        font-size: 0.875rem;
        color: #444;
        line-height: 1.6;
        margin: 0;
    }
    
    /* Promo Code Section */
    .promo-section {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(47, 46, 12, 0.08);
    }
    
    .promo-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        cursor: pointer;
        color: #292808;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .promo-toggle:hover {
        color: #1a1a06;
    }
    
    .promo-toggle svg {
        width: 16px;
        height: 16px;
        transition: transform 0.3s ease;
    }
    
    .promo-toggle.open svg {
        transform: rotate(90deg);
    }
    
    .promo-form {
        display: none;
        margin-top: 0.75rem;
    }
    
    .promo-form.show {
        display: block;
    }
    
    .promo-input-row {
        display: flex;
        gap: 0.5rem;
    }
    
    .promo-input-row input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        font-size: 0.875rem;
        text-transform: uppercase;
        transition: border-color 0.3s ease;
    }
    
    .promo-input-row input:focus {
        outline: none;
        border-color: #292808;
    }
    
    .promo-input-row button {
        padding: 0.75rem 1.25rem;
        background: #292808;
        color: #d4ff9e;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .promo-input-row button:hover {
        background: #1a1a06;
    }
    
    .promo-input-row button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .promo-message {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        display: none;
    }
    
    .promo-message.success {
        display: block;
        background: #d1fae5;
        color: #065f46;
    }
    
    .promo-message.error {
        display: block;
        background: #fee2e2;
        color: #991b1b;
    }
    
    .promo-applied {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        margin-top: 0.75rem;
    }
    
    .promo-applied-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .promo-applied-code {
        font-weight: 600;
        color: #065f46;
        text-transform: uppercase;
    }
    
    .promo-applied-label {
        font-size: 0.75rem;
        color: #16a34a;
    }
    
    .promo-remove {
        background: none;
        border: none;
        color: #991b1b;
        cursor: pointer;
        font-size: 0.8125rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: background 0.3s ease;
    }
    
    .promo-remove:hover {
        background: #fef2f2;
    }
    
    /* Order Summary Panel */
    .order-panel {
        background: white;
        border-radius: 20px;
        border: 1px solid rgba(47, 46, 12, 0.06);
        overflow: hidden;
        position: sticky;
        top: 120px;
        box-shadow: 0 4px 20px rgba(47, 46, 12, 0.06);
    }
    
    .order-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
    }
    
    .order-header h2 {
        font-size: 1.125rem;
        font-weight: 700;
        color: #292808;
        margin: 0;
    }
    
    .edit-cart {
        font-size: 0.8125rem;
        color: #292808;
        text-decoration: none;
        font-weight: 600;
        padding: 0.375rem 0.875rem;
        background: #f0f0f0;
        border-radius: 50px;
        transition: all 0.3s ease;
    }
    
    .edit-cart:hover {
        background: #e5e5e5;
        color: #292808;
    }
    
    .order-items {
        max-height: 300px;
        overflow-y: auto;
        padding: 1rem 1.5rem;
    }
    
    .order-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .order-item-img {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        object-fit: cover;
        background: #f5f5f5;
        flex-shrink: 0;
    }
    
    .order-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .order-item-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: #292808;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .order-item-qty {
        font-size: 0.8125rem;
        color: #666;
    }
    
    /* Order Item Quantity Controls */
    .order-item-qty-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.25rem;
    }
    
    .order-qty-btn {
        width: 24px;
        height: 24px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        color: #666;
        transition: all 0.2s ease;
    }
    
    .order-qty-btn:hover {
        background: #f5f5f5;
        border-color: #ccc;
    }
    
    .order-qty-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .order-qty-display {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #333;
        min-width: 20px;
        text-align: center;
    }
    
    .order-item-remove {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        margin-left: auto;
    }
    
    .order-item-remove:hover {
        color: #d32f2f;
        background: #ffebee;
    }
    
    .order-item-remove svg {
        width: 14px;
        height: 14px;
    }

    .order-item-price {
        font-size: 0.9375rem;
        font-weight: 700;
        color: #292808;
    }
    
    .order-totals {
        padding: 1.25rem 1.5rem;
        background: #fafafa;
        border-top: 1px solid #f0f0f0;
    }
    
    .total-line {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        font-size: 0.875rem;
        color: #666;
    }
    
    .total-line.grand {
        padding-top: 1rem;
        margin-top: 0.5rem;
        border-top: 2px solid #e5e5e5;
        font-size: 1.125rem;
        font-weight: 700;
        color: #292808;
    }
    
    /* Submit Section */
    .submit-section {
        padding: 1.5rem;
    }
    
    .place-order-btn {
        width: 100%;
        padding: 1rem;
        background: #292808;
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .place-order-btn:hover {
        background: #292808;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(47, 46, 12, 0.25);
    }
    
    .place-order-btn:active {
        transform: translateY(0);
    }
    
    .place-order-btn .btn-text {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .place-order-btn .btn-text svg {
        width: 20px;
        height: 20px;
    }
    
    .place-order-btn .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .place-order-btn.loading .btn-text {
        display: none;
    }
    
    .place-order-btn.loading .spinner {
        display: block;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .secure-note {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.75rem;
        color: #888;
    }
    
    .secure-note svg {
        width: 14px;
        height: 14px;
    }
    
    /* Stripe Elements Styling */
    .payment-section {
        border: 2px solid transparent;
        background: linear-gradient(white, white) padding-box,
                    linear-gradient(135deg, #d4ff9e 0%, #a8e65c 100%) border-box;
    }
    
    .payment-badges {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .payment-badges svg {
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stripe-element-container {
        margin-top: 1rem;
    }
    
    .stripe-element {
        padding: 1rem;
        border: 2px solid #e5e5e5;
        border-radius: 12px;
        background: #fafafa;
        transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        min-height: 50px;
    }
    
    .stripe-element:hover {
        border-color: #ccc;
        background: white;
    }
    
    .stripe-element.StripeElement--focus {
        border-color: #d4ff9e;
        background: white;
        box-shadow: 0 0 0 4px rgba(212, 255, 158, 0.15);
    }
    
    .stripe-element.StripeElement--invalid {
        border-color: #dc3545;
        background: #fff8f8;
    }
    
    .stripe-error {
        color: #dc3545;
        font-size: 0.8125rem;
        margin-top: 0.5rem;
        min-height: 1.25em;
    }
    
    .payment-security {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.875rem 1rem;
        background: linear-gradient(135deg, #f8fff0 0%, #f0fff0 100%);
        border-radius: 10px;
        font-size: 0.8125rem;
        color: #555;
        border: 1px solid rgba(212, 255, 158, 0.3);
    }
    
    .payment-security svg {
        color: #28a745;
        flex-shrink: 0;
    }
    
    .payment-security strong {
        color: #635BFF;
    }
    
    /* Processing Overlay */
    .processing-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .processing-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .processing-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #f0f0f0;
        border-top-color: #d4ff9e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }
    
    .processing-text {
        font-size: 1.125rem;
        font-weight: 600;
        color: #292808;
        margin-bottom: 0.5rem;
    }
    
    .processing-subtext {
        font-size: 0.875rem;
        color: #666;
    }

    /* Mobile Order Summary Toggle */
    .mobile-summary-toggle {
        display: none;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: white;
        border-radius: 12px;
        margin-bottom: 1rem;
        cursor: pointer;
        font-weight: 600;
        border: 1px solid #e5e5e5;
    }
    
    .mobile-summary-toggle .toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .mobile-summary-toggle.open .toggle-icon {
        transform: rotate(180deg);
    }
    
    @media (max-width: 900px) {
        .mobile-summary-toggle {
            display: flex;
        }
        
        .order-panel {
            display: none;
            position: static;
        }
        
        .order-panel.show {
            display: block;
            margin-bottom: 1.5rem;
        }
    }
    
    /* Additional Mobile Optimizations (480px and below) */
    @media (max-width: 480px) {
        .checkout-container {
            padding: 0 0.75rem;
        }
        
        .checkout-hero h1 {
            font-size: 1.5rem;
        }
        
        .checkout-hero p {
            font-size: 0.875rem;
        }
        
        .form-section {
            padding: 1.25rem;
            border-radius: 16px;
        }
        
        .section-header {
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 1rem;
        }
        
        .section-icon {
            width: 36px;
            height: 36px;
        }
        
        .field label {
            font-size: 0.75rem;
        }
        
        .field input,
        .field select,
        .field textarea {
            padding: 0.75rem;
            font-size: 16px; /* Prevents iOS zoom */
        }
        
        .billing-toggle {
            padding: 0.875rem;
        }
        
        .toggle-text {
            font-size: 0.8125rem;
        }
        
        .order-panel {
            border-radius: 16px;
        }
        
        .order-panel-body {
            padding: 1rem;
        }
        
        .order-item {
            gap: 0.75rem;
        }
        
        .order-item-image {
            width: 50px;
            height: 50px;
        }
        
        .order-item-title {
            font-size: 0.8125rem;
        }
        
        .total-row {
            padding: 1rem;
        }
        
        .total-amount {
            font-size: 1.375rem;
        }
        
        .place-order-btn {
            padding: 1rem;
            font-size: 0.9375rem;
        }
        
        .trust-indicators {
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .mobile-summary-toggle {
            font-size: 0.875rem;
            padding: 0.875rem 1rem;
        }
    }
    
    /* Small Mobile (375px) */
    @media (max-width: 375px) {
        .checkout-hero {
            padding: 100px 0 40px;
        }
        
        .checkout-hero h1 {
            font-size: 1.375rem;
        }
        
        .form-section {
            padding: 1rem;
        }
        
        .section-title {
            font-size: 0.9375rem;
            gap: 0.5rem;
        }
        
        .field-hint {
            font-size: 0.6875rem;
        }
        
        .place-order-btn {
            padding: 0.875rem;
        }
        
        .total-amount {
            font-size: 1.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="checkout-hero">
    <div class="container">
        <div class="checkout-hero-content">
            <nav class="breadcrumb" aria-label="Breadcrumb">
                <a href="{% url 'core:index' %}">Home</a>
                <span class="separator">/</span>
                <a href="{% url 'core:cart' %}">Cart</a>
                <span class="separator">/</span>
                <span class="current">Checkout</span>
            </nav>
            <h1>Secure <span>Checkout</span></h1>
            <p>Complete your order with our safe and easy checkout process</p>
        </div>
    </div>
</section>

<div class="checkout-main">
<section class="checkout-page">
    <div class="checkout-container">
        <a href="{% url 'core:cart' %}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back to Cart
        </a>
        
        <!-- Progress Steps -->
        <div class="checkout-progress">
            <div class="progress-step done">
                <span class="step-num">✓</span>
                <span>Cart</span>
            </div>
            <div class="progress-line done"></div>
            <div class="progress-step active">
                <span class="step-num">2</span>
                <span>Checkout</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step">
                <span class="step-num">3</span>
                <span>Confirmation</span>
            </div>
        </div>
        
        <!-- Mobile Order Summary Toggle -->
        <div class="mobile-summary-toggle" id="summaryToggle" data-items-count="{{ cart.total_items }}">
            <span>Order Summary ({{ cart.total_items }} item{{ cart.total_items|pluralize }}) - ${{ order_totals.grand_total }}</span>
            <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </div>
        
        <form method="POST" id="checkoutForm" novalidate>
            {% csrf_token %}
            
            <div class="checkout-grid">
                <!-- Form Side -->
                <div class="form-side">
                    <!-- Contact Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                                Contact Information
                            </h3>
                        </div>
                        
                        <div class="field-row">
                            <div class="field">
                                <label for="checkout-first-name">First Name <span class="req" aria-hidden="true">*</span></label>
                                <input type="text" name="first_name" id="checkout-first-name" required autocomplete="given-name" autofocus placeholder="John" aria-required="true" aria-describedby="first-name-error">
                                <span class="field-error" id="first-name-error" role="alert">Please enter your first name</span>
                            </div>
                            <div class="field">
                                <label for="checkout-last-name">Last Name <span class="req" aria-hidden="true">*</span></label>
                                <input type="text" name="last_name" id="checkout-last-name" required autocomplete="family-name" placeholder="Smith" aria-required="true" aria-describedby="last-name-error">
                                <span class="field-error" id="last-name-error" role="alert">Please enter your last name</span>
                            </div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field">
                                <label for="checkout-email">Email <span class="req" aria-hidden="true">*</span></label>
                                <input type="email" name="email" id="checkout-email" required autocomplete="email" placeholder="john@company.com" aria-required="true" aria-describedby="email-error">
                                <span class="field-error" id="email-error" role="alert">Please enter a valid email</span>
                            </div>
                            <div class="field">
                                <label for="checkout-phone">Phone <span class="req" aria-hidden="true">*</span></label>
                                <input type="tel" name="phone" id="checkout-phone" required autocomplete="tel" placeholder="(416) 555-0123" aria-required="true" aria-describedby="phone-error" inputmode="tel">
                                <span class="field-error" id="phone-error" role="alert">Please enter your phone number</span>
                            </div>
                        </div>
                        
                        <div class="field-row single">
                            <div class="field">
                                <label for="checkout-company">Company Name <span class="optional">(optional)</span></label>
                                <input type="text" name="company_name" id="checkout-company" autocomplete="organization" placeholder="Your Company Inc.">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                Shipping Address
                            </h3>
                        </div>
                        
                        <div class="field-row single">
                            <div class="field">
                                <label>Street Address <span class="req">*</span></label>
                                <div class="address-input-wrapper">
                                    <input type="text" name="shipping_address_1" id="shipping_address_autocomplete" required autocomplete="street-address" placeholder="123 Main Street">
                                    <svg class="address-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                <span class="field-error">Please enter your address</span>
                            </div>
                        </div>
                        
                        <div class="field-row single">
                            <div class="field">
                                <label>Apt, Suite, Unit <span class="optional">(optional)</span></label>
                                <input type="text" name="shipping_address_2" autocomplete="address-line2" placeholder="Unit 100">
                            </div>
                        </div>
                        
                        <div class="field-row triple">
                            <div class="field">
                                <label>City <span class="req">*</span></label>
                                <input type="text" name="shipping_city" id="shipping_city" required autocomplete="address-level2" placeholder="Toronto">
                                <span class="field-error">Please enter your city</span>
                            </div>
                            <div class="field">
                                <label>Province <span class="req">*</span></label>
                                <select name="shipping_state" id="shipping_state" required autocomplete="address-level1">
                                    <option value="">Select</option>
                                    <option value="ON" {% if selected_province == 'ON' %}selected{% endif %}>Ontario</option>
                                    <option value="BC" {% if selected_province == 'BC' %}selected{% endif %}>British Columbia</option>
                                    <option value="AB" {% if selected_province == 'AB' %}selected{% endif %}>Alberta</option>
                                    <option value="QC" {% if selected_province == 'QC' %}selected{% endif %}>Quebec</option>
                                    <option value="MB" {% if selected_province == 'MB' %}selected{% endif %}>Manitoba</option>
                                    <option value="SK" {% if selected_province == 'SK' %}selected{% endif %}>Saskatchewan</option>
                                    <option value="NS" {% if selected_province == 'NS' %}selected{% endif %}>Nova Scotia</option>
                                    <option value="NB" {% if selected_province == 'NB' %}selected{% endif %}>New Brunswick</option>
                                    <option value="NL" {% if selected_province == 'NL' %}selected{% endif %}>Newfoundland</option>
                                    <option value="PE" {% if selected_province == 'PE' %}selected{% endif %}>PEI</option>
                                    <option value="NT" {% if selected_province == 'NT' %}selected{% endif %}>NWT</option>
                                    <option value="NU" {% if selected_province == 'NU' %}selected{% endif %}>Nunavut</option>
                                    <option value="YT" {% if selected_province == 'YT' %}selected{% endif %}>Yukon</option>
                                </select>
                                <span class="field-error">Required</span>
                            </div>
                            <div class="field">
                                <label>Postal Code <span class="req">*</span></label>
                                <input type="text" name="shipping_postal_code" id="shipping_postal_code" required autocomplete="postal-code" placeholder="M5V 1A1" style="text-transform: uppercase;">
                                <span class="field-error">Required</span>
                            </div>
                        </div>
                        
                        <div class="field-row single">
                            <div class="field">
                                <label>Country</label>
                                <input type="text" name="shipping_country" value="Canada" readonly style="background: #f0f0f0; color: #666; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Billing Address -->
                    <!-- Delivery & Shipping -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 3h15l3 7v11a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V3z"></path>
                                        <circle cx="7.5" cy="18.5" r="1.5"></circle>
                                        <circle cx="18.5" cy="18.5" r="1.5"></circle>
                                    </svg>
                                </div>
                                Delivery &amp; Shipping
                            </h3>
                        </div>

                        <div class="shipping-options" id="shippingOptions">
                            {% for method in shipping_methods %}
                            <label class="shipping-option{% if method.id == selected_shipping_method_id %} active{% endif %}">
                                <input type="radio" name="shipping_method" value="{{ method.id }}" {% if method.id == selected_shipping_method_id %}checked{% endif %} data-cost="{{ method.cost }}" data-eta="{{ method.eta }}" data-label="{{ method.label }}">
                                <div class="selected-indicator"></div>
                                <div>
                                    <div class="shipping-option-header">
                                        <h4>{{ method.label }}</h4>
                                        <span class="shipping-price">{{ method.display_cost }}</span>
                                        {% if method.badge %}
                                        <span class="shipping-option-badge">{{ method.badge }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="shipping-meta">
                                        <span>{{ method.description }}</span>
                                        <span>{{ method.eta }}</span>
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Billing Address -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                </div>
                                Billing Address
                            </h3>
                        </div>
                        
                        <label class="billing-toggle">
                            <input type="checkbox" id="differentBilling" name="different_billing">
                            <span class="toggle-switch"></span>
                            <span class="toggle-text">
                                Use a different billing address
                                <span>Default: Same as shipping address</span>
                            </span>
                        </label>
                        
                        <div class="billing-fields" id="billingFields">
                            <div class="field-row single">
                                <div class="field">
                                    <label>Street Address</label>
                                    <div class="address-input-wrapper">
                                        <input type="text" name="billing_address_1" id="billing_address_autocomplete" placeholder="123 Main Street">
                                        <svg class="address-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field-row single">
                                <div class="field">
                                    <label>Apt, Suite, Unit <span class="optional">(optional)</span></label>
                                    <input type="text" name="billing_address_2" placeholder="Unit 100">
                                </div>
                            </div>
                            
                            <div class="field-row triple">
                                <div class="field">
                                    <label>City</label>
                                    <input type="text" name="billing_city" id="billing_city" placeholder="Toronto">
                                </div>
                                <div class="field">
                                    <label>Province</label>
                                    <select name="billing_state" id="billing_state">
                                        <option value="">Select</option>
                                        <option value="ON">Ontario</option>
                                        <option value="BC">British Columbia</option>
                                        <option value="AB">Alberta</option>
                                        <option value="QC">Quebec</option>
                                        <option value="MB">Manitoba</option>
                                        <option value="SK">Saskatchewan</option>
                                        <option value="NS">Nova Scotia</option>
                                        <option value="NB">New Brunswick</option>
                                        <option value="NL">Newfoundland</option>
                                        <option value="PE">PEI</option>
                                        <option value="NT">NWT</option>
                                        <option value="NU">Nunavut</option>
                                        <option value="YT">Yukon</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>Postal Code</label>
                                    <input type="text" name="billing_postal_code" id="billing_postal_code" placeholder="M5V 1A1" style="text-transform: uppercase;">
                                </div>
                            </div>
                            
                            <div class="field-row single">
                                <div class="field">
                                    <label>Country</label>
                                    <input type="text" name="billing_country" value="Canada" readonly style="background: #f0f0f0; color: #666; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Notes -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                    </svg>
                                </div>
                                Additional Notes
                            </h3>
                        </div>
                        
                        <div class="field-row single">
                            <div class="field">
                                <label>Order Notes <span class="optional">(optional)</span></label>
                                <textarea name="customer_notes" placeholder="Any special instructions for delivery or your order..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    {% if online_payments_enabled %}
                    <!-- Payment Section - Stripe Elements -->
                    <div class="form-section payment-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                </div>
                                Payment Details
                            </h3>
                            <div class="payment-badges">
                                <svg xmlns="http://www.w3.org/2000/svg" width="38" height="24" viewBox="0 0 38 24" aria-label="Visa">
                                    <rect width="38" height="24" rx="3" fill="#1434CB"/>
                                    <path d="M15 17.5l1.5-9h2.4l-1.5 9H15zm9.3-9c-.5-.2-1.3-.4-2.3-.4-2.5 0-4.3 1.3-4.3 3.2 0 1.4 1.3 2.2 2.3 2.6 1 .5 1.4.8 1.4 1.2 0 .6-.8 1-1.6 1-.9 0-1.8-.2-2.5-.5l-.4 2.2c.8.3 1.9.5 3.1.5 2.7 0 4.5-1.3 4.5-3.3 0-1.1-.7-2-2.2-2.7-1-.5-1.5-.8-1.5-1.3 0-.4.5-.9 1.5-.9.8 0 1.5.2 2 .4l.3-2zm5.7-.1l-1.9 9.1h-2.2l.1-.6-3.5-8.5h2.6l2 5.7.6-5.7h2.3zm-22.1 9.1l-2.4-9h2.7l1.4 6.5 1.5-6.5h2.4l-2.6 9h-3z" fill="#fff"/>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" width="38" height="24" viewBox="0 0 38 24" aria-label="Mastercard">
                                    <rect width="38" height="24" rx="3" fill="#000"/>
                                    <circle cx="15" cy="12" r="7" fill="#EB001B"/>
                                    <circle cx="23" cy="12" r="7" fill="#F79E1B"/>
                                    <path d="M19 7a7 7 0 0 0 0 10 7 7 0 0 0 0-10z" fill="#FF5F00"/>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" width="38" height="24" viewBox="0 0 38 24" aria-label="Amex">
                                    <rect width="38" height="24" rx="3" fill="#006FCF"/>
                                    <path d="M8.5 11.5h2l1 2.5 1-2.5h2v4h-1.5v-3l-1 3h-1l-1-3v3H8.5v-4zm9 0h4v1h-2.5v.5h2.5v1h-2.5v.5h2.5v1h-4v-4z" fill="#fff"/>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="stripe-element-container">
                            <div class="field-row single">
                                <div class="field">
                                    <label>Card Details <span class="req">*</span></label>
                                    <div id="card-element" class="stripe-element"></div>
                                    <div id="card-errors" class="stripe-error" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-security">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            <span>Your payment information is encrypted and secure. Powered by <strong>Stripe</strong>.</span>
                        </div>
                    </div>
                    {% else %}
                    <!-- Payment Info - Manual Payment -->
                    <div class="form-section payment-info-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                </div>
                                Payment Information
                            </h3>
                        </div>
                        <div class="payment-notice">
                            <div class="notice-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                            </div>
                            <div class="notice-content">
                                <strong>Payment after order</strong>
                                <p>After placing your order, our team will contact you within 24 hours to finalize payment. We accept e-Transfer, credit cards, and cheque.</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Order Summary Panel -->
                <div class="order-panel" id="orderPanel">
                    <div class="order-header">
                        <h2>Order Summary</h2>
                        <a href="{% url 'core:cart' %}" class="edit-cart">Edit Cart</a>
                    </div>
                    
                    <div class="order-items">
                        {% for item in cart_items %}
                        <div class="order-item" data-item-id="{{ item.id }}" data-unit-price="{{ item.unit_price }}">
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.title }}" class="order-item-img">
                            {% else %}
                            <div class="order-item-img" style="display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                </svg>
                            </div>
                            {% endif %}
                            <div class="order-item-info">
                                <div class="order-item-name">{{ item.product.title }}</div>
                                <div class="order-item-qty-controls">
                                    <button type="button" class="order-qty-btn order-qty-minus" onclick="updateCheckoutQty({{ item.id }}, -1)">−</button>
                                    <span class="order-qty-display" id="qty-{{ item.id }}">{{ item.quantity }}</span>
                                    <button type="button" class="order-qty-btn order-qty-plus" onclick="updateCheckoutQty({{ item.id }}, 1)">+</button>
                                    <span style="color: #888; font-size: 0.75rem;">× ${{ item.unit_price }}</span>
                                    <button type="button" class="order-item-remove" onclick="removeCheckoutItem({{ item.id }})" title="Remove">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="order-item-price" id="price-{{ item.id }}">${{ item.total_price }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Promo Code Section -->
                    <div class="promo-section">
                        <div class="promo-toggle" id="promoToggle">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            Have a promo code?
                        </div>
                        <div class="promo-form" id="promoForm">
                            <div id="promoApplied" class="promo-applied" style="display: none;">
                                <div class="promo-applied-info">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                    <span class="promo-applied-code" id="appliedCode"></span>
                                    <span class="promo-applied-label" id="appliedLabel"></span>
                                </div>
                                <button type="button" class="promo-remove" id="promoRemove">Remove</button>
                            </div>
                            <div id="promoInputArea">
                                <div class="promo-input-row">
                                    <input type="text" id="promoCodeInput" placeholder="Enter code" maxlength="50">
                                    <button type="button" id="promoApplyBtn">Apply</button>
                                </div>
                                <div class="promo-message" id="promoMessage"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-totals">
                        <div class="total-line">
                            <span>Subtotal</span>
                            <span id="orderSubtotal" data-amount="{{ cart.subtotal }}">${{ cart.subtotal }}</span>
                        </div>
                        <div class="total-line" id="discountLine" style="display: none; color: #16a34a;">
                            <span>Discount</span>
                            <span id="orderDiscount" data-amount="0">-$0.00</span>
                        </div>
                        <div class="total-line">
                            <span>Shipping <small id="orderShippingLabel">({{ order_totals.selected_method.label }})</small></span>
                            {% if order_totals.shipping_cost == 0 %}
                            <span id="orderShipping" data-amount="0">Free</span>
                            {% else %}
                            <span id="orderShipping" data-amount="{{ order_totals.shipping_cost }}">${{ order_totals.shipping_cost }}</span>
                            {% endif %}
                        </div>
                        <div class="total-line">
                            <span>Tax (<span id="orderTaxProvince">{{ order_totals.province }}</span>)</span>
                            <span id="orderTax" data-amount="{{ order_totals.tax_amount }}">${{ order_totals.tax_amount }}</span>
                        </div>
                        <div class="total-line grand">
                            <span>Estimated Total</span>
                            <span id="orderGrandTotal" data-amount="{{ order_totals.grand_total }}">${{ order_totals.grand_total }}</span>
                        </div>
                    </div>
                    
                    <!-- Hidden input for promo code submission -->
                    <input type="hidden" name="promo_code" id="promoCodeHidden" value="">
                    
                    <div class="submit-section">
                        <button type="submit" class="place-order-btn" id="submitBtn">
                            <span class="spinner"></span>
                            <span class="btn-text">
                                {% if online_payments_enabled %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                Pay <span id="payButtonAmount">${{ order_totals.grand_total }}</span> CAD
                                {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"></path>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                </svg>
                                Place Order
                                {% endif %}
                            </span>
                        </button>
                        <div class="secure-note">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            {% if online_payments_enabled %}
                            Secure payment powered by Stripe
                            {% else %}
                            Your information is secure & encrypted
                            {% endif %}
                        </div>
                        
                        <!-- Trust Badges -->
                        <div class="trust-badges" style="display: flex; justify-content: center; gap: 1.5rem; margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
                            <div class="trust-badge" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                    <polyline points="9 12 12 15 16 9"></polyline>
                                </svg>
                                <span style="font-size: 0.65rem; color: #666;">SSL Secure</span>
                            </div>
                            <div class="trust-badge" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2">
                                    <rect x="1" y="3" width="15" height="13" rx="2" ry="2"></rect>
                                    <path d="M16 8h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-8"></path>
                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                </svg>
                                <span style="font-size: 0.65rem; color: #666;">Free Shipping*</span>
                            </div>
                            <div class="trust-badge" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                <span style="font-size: 0.65rem; color: #666;">24/7 Support</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Processing Overlay -->
        <div class="processing-overlay" id="processingOverlay">
            <div class="processing-spinner"></div>
            {% if online_payments_enabled %}
            <div class="processing-text">Processing your payment...</div>
            {% else %}
            <div class="processing-text">Processing your order...</div>
            {% endif %}
            <div class="processing-subtext">Please don't close this window</div>
        </div>
    </div>
</section>
</div><!-- End checkout-main -->
{% endblock %}

{% block extra_js %}
{% if online_payments_enabled %}
<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
{% endif %}

{{ tax_rates|json_script:"tax-rates-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    const summaryToggle = document.getElementById('summaryToggle');
    const summaryToggleText = summaryToggle ? summaryToggle.querySelector('span') : null;
    const orderPanel = document.getElementById('orderPanel');
    const processingOverlay = document.getElementById('processingOverlay');
    const taxRates = JSON.parse(document.getElementById('tax-rates-data').textContent || '{}');
    const shippingMethodInputs = Array.from(document.querySelectorAll('input[name="shipping_method"]'));
    const shippingStateSelect = document.getElementById('shipping_state');
    const orderSubtotalElem = document.getElementById('orderSubtotal');
    const orderShippingElem = document.getElementById('orderShipping');
    const orderShippingLabelElem = document.getElementById('orderShippingLabel');
    const orderTaxElem = document.getElementById('orderTax');
    const orderTaxProvinceElem = document.getElementById('orderTaxProvince');
    const orderGrandTotalElem = document.getElementById('orderGrandTotal');
    const payButtonAmountElem = document.getElementById('payButtonAmount');
    const itemsCount = parseInt(summaryToggle?.dataset.itemsCount || '0', 10);
    const subtotalAmount = parseFloat(orderSubtotalElem?.dataset.amount || '0');
    const fallbackProvince = orderTaxProvinceElem ? orderTaxProvinceElem.textContent.trim().toUpperCase() : 'ON';
    const defaultProvinceFromServer = '{{ selected_province }}'.trim().toUpperCase();

    if (shippingStateSelect && !shippingStateSelect.value && defaultProvinceFromServer) {
        shippingStateSelect.value = defaultProvinceFromServer;
    }

    function parseDecimal(value) {
        const parsed = parseFloat(value);
        return Number.isNaN(parsed) ? 0 : parsed;
    }

    function roundCurrency(value) {
        return Math.round((value + Number.EPSILON) * 100) / 100;
    }

    function formatCurrency(amount) {
        return '$' + amount.toFixed(2);
    }

    function pluralizeItem(count) {
        return count === 1 ? 'item' : 'items';
    }

    function updateShippingActiveState() {
        shippingMethodInputs.forEach(input => {
            const option = input.closest('.shipping-option');
            if (option) {
                option.classList.toggle('active', input.checked);
            }
        });
    }

    function updateDisplayedTotals() {
        const selectedShipping = shippingMethodInputs.find(input => input.checked);
        const shippingCost = selectedShipping ? parseDecimal(selectedShipping.dataset.cost) : 0;
        const provinceRaw = shippingStateSelect ? shippingStateSelect.value.trim().toUpperCase() : fallbackProvince;
        const provinceCode = provinceRaw || fallbackProvince;
        const rawRate = taxRates[provinceCode] ?? taxRates[fallbackProvince] ?? taxRates.ON ?? 0;
        const taxRate = parseDecimal(rawRate);
        const taxAmount = roundCurrency(subtotalAmount * taxRate);
        const grandTotal = roundCurrency(subtotalAmount + shippingCost + taxAmount);

        if (orderShippingElem) {
            orderShippingElem.dataset.amount = shippingCost.toFixed(2);
            orderShippingElem.textContent = shippingCost === 0 ? 'Free' : formatCurrency(shippingCost);
        }

        if (orderShippingLabelElem && selectedShipping) {
            orderShippingLabelElem.textContent = '(' + (selectedShipping.dataset.label || 'Shipping') + ')';
        } else if (orderShippingLabelElem) {
            orderShippingLabelElem.textContent = '(Shipping)';
        }

        if (orderTaxElem) {
            orderTaxElem.dataset.amount = taxAmount.toFixed(2);
            orderTaxElem.textContent = formatCurrency(taxAmount);
        }

        if (orderTaxProvinceElem) {
            orderTaxProvinceElem.textContent = provinceCode;
        }

        if (orderGrandTotalElem) {
            orderGrandTotalElem.dataset.amount = grandTotal.toFixed(2);
            orderGrandTotalElem.textContent = formatCurrency(grandTotal);
        }

        if (payButtonAmountElem) {
            payButtonAmountElem.textContent = formatCurrency(grandTotal);
        }

        if (summaryToggleText) {
            summaryToggleText.textContent = `Order Summary (${itemsCount} ${pluralizeItem(itemsCount)}) - ${formatCurrency(grandTotal)}`;
        }

        updateShippingActiveState();
    }

    updateDisplayedTotals();

    shippingMethodInputs.forEach(input => {
        input.addEventListener('change', updateDisplayedTotals);
    });

    if (shippingStateSelect) {
        shippingStateSelect.addEventListener('change', updateDisplayedTotals);
    }
    
    // ============================================
    // PROMO CODE FUNCTIONALITY
    // ============================================
    const promoToggle = document.getElementById('promoToggle');
    const promoForm = document.getElementById('promoForm');
    const promoInputArea = document.getElementById('promoInputArea');
    const promoApplied = document.getElementById('promoApplied');
    const promoCodeInput = document.getElementById('promoCodeInput');
    const promoApplyBtn = document.getElementById('promoApplyBtn');
    const promoMessage = document.getElementById('promoMessage');
    const promoRemove = document.getElementById('promoRemove');
    const promoCodeHidden = document.getElementById('promoCodeHidden');
    const discountLine = document.getElementById('discountLine');
    const orderDiscount = document.getElementById('orderDiscount');
    let currentDiscount = 0;
    
    // Toggle promo form visibility
    if (promoToggle) {
        promoToggle.addEventListener('click', function() {
            this.classList.toggle('open');
            promoForm.classList.toggle('show');
        });
    }
    
    // Apply promo code
    if (promoApplyBtn) {
        promoApplyBtn.addEventListener('click', async function() {
            const code = promoCodeInput.value.trim();
            if (!code) {
                showPromoMessage('Please enter a promo code.', 'error');
                return;
            }
            
            promoApplyBtn.disabled = true;
            promoApplyBtn.textContent = 'Applying...';
            
            try {
                const response = await fetch('{% url "core:apply_promo_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        code: code,
                        email: document.getElementById('checkout-email')?.value || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show applied state
                    document.getElementById('appliedCode').textContent = data.code;
                    document.getElementById('appliedLabel').textContent = data.discount_label;
                    promoInputArea.style.display = 'none';
                    promoApplied.style.display = 'flex';
                    promoCodeHidden.value = data.code;
                    
                    // Update discount display
                    currentDiscount = data.discount;
                    if (currentDiscount > 0) {
                        discountLine.style.display = 'flex';
                        orderDiscount.textContent = '-$' + currentDiscount.toFixed(2);
                        orderDiscount.dataset.amount = currentDiscount.toFixed(2);
                    }
                    
                    // Recalculate totals with discount
                    updateTotalsWithDiscount();
                    
                    showPromoMessage(data.message, 'success');
                } else {
                    showPromoMessage(data.error, 'error');
                }
            } catch (error) {
                showPromoMessage('Something went wrong. Please try again.', 'error');
            } finally {
                promoApplyBtn.disabled = false;
                promoApplyBtn.textContent = 'Apply';
            }
        });
    }
    
    // Remove promo code
    if (promoRemove) {
        promoRemove.addEventListener('click', async function() {
            try {
                await fetch('{% url "core:remove_promo_code" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                // Reset UI
                promoInputArea.style.display = 'block';
                promoApplied.style.display = 'none';
                promoCodeInput.value = '';
                promoCodeHidden.value = '';
                discountLine.style.display = 'none';
                currentDiscount = 0;
                promoMessage.className = 'promo-message';
                promoMessage.textContent = '';
                
                // Recalculate totals
                updateTotalsWithDiscount();
            } catch (error) {
                console.error('Error removing promo code:', error);
            }
        });
    }
    
    // Allow Enter key to apply promo
    if (promoCodeInput) {
        promoCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                promoApplyBtn.click();
            }
        });
    }
    
    function showPromoMessage(message, type) {
        promoMessage.textContent = message;
        promoMessage.className = 'promo-message ' + type;
        
        if (type === 'success') {
            setTimeout(() => {
                promoMessage.className = 'promo-message';
            }, 5000);
        }
    }
    
    function updateTotalsWithDiscount() {
        const selectedShipping = shippingMethodInputs.find(input => input.checked);
        const shippingCost = selectedShipping ? parseDecimal(selectedShipping.dataset.cost) : 0;
        const provinceRaw = shippingStateSelect ? shippingStateSelect.value.trim().toUpperCase() : fallbackProvince;
        const provinceCode = provinceRaw || fallbackProvince;
        const rawRate = taxRates[provinceCode] ?? taxRates[fallbackProvince] ?? taxRates.ON ?? 0;
        const taxRate = parseDecimal(rawRate);
        
        const discountedSubtotal = subtotalAmount - currentDiscount;
        const taxAmount = roundCurrency(discountedSubtotal * taxRate);
        const grandTotal = roundCurrency(discountedSubtotal + shippingCost + taxAmount);

        if (orderTaxElem) {
            orderTaxElem.dataset.amount = taxAmount.toFixed(2);
            orderTaxElem.textContent = formatCurrency(taxAmount);
        }

        if (orderGrandTotalElem) {
            orderGrandTotalElem.dataset.amount = grandTotal.toFixed(2);
            orderGrandTotalElem.textContent = formatCurrency(grandTotal);
        }

        if (payButtonAmountElem) {
            payButtonAmountElem.textContent = formatCurrency(grandTotal);
        }

        if (summaryToggleText) {
            summaryToggleText.textContent = `Order Summary (${itemsCount} ${pluralizeItem(itemsCount)}) - ${formatCurrency(grandTotal)}`;
        }
    }
    
    {% if online_payments_enabled %}
    // Initialize Stripe
    const stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}');
    const elements = stripe.elements({
        fonts: [
            {
                cssSrc: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap',
            }
        ]
    });
    
    // Custom Stripe Element styling to match theme
    const cardStyle = {
        base: {
            color: '#292808',
            fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            fontWeight: '500',
            '::placeholder': {
                color: '#999',
            },
        },
        invalid: {
            color: '#dc3545',
            iconColor: '#dc3545',
        },
    };
    
    // Create and mount the Card Element
    const cardElement = elements.create('card', {
        style: cardStyle,
        hidePostalCode: true, // We're collecting postal code separately
    });
    cardElement.mount('#card-element');
    
    // Handle card errors
    const cardErrors = document.getElementById('card-errors');
    cardElement.on('change', function(event) {
        if (event.error) {
            cardErrors.textContent = event.error.message;
        } else {
            cardErrors.textContent = '';
        }
    });
    {% endif %}
    
    // Mobile summary toggle
    if (summaryToggle) {
        summaryToggle.addEventListener('click', function() {
            this.classList.toggle('open');
            orderPanel?.classList.toggle('show');
        });
    }
    
    // Billing address toggle
    const billingToggle = document.getElementById('differentBilling');
    const billingFields = document.getElementById('billingFields');
    
    if (billingToggle && billingFields) {
        billingToggle.addEventListener('change', function() {
            if (this.checked) {
                billingFields.classList.add('show');
            } else {
                billingFields.classList.remove('show');
                billingFields.querySelectorAll('input, select').forEach(field => {
                    if (field.type !== 'text' || !field.readOnly) {
                        field.value = field.tagName === 'SELECT' ? '' : '';
                    }
                    field.closest('.field')?.classList.remove('has-error');
                    field.classList.remove('error');
                });
            }
        });
    }
    
    // Form validation
    const requiredFields = form.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateField(this);
        });
        
        field.addEventListener('input', function() {
            if (this.closest('.field').classList.contains('has-error')) {
                validateField(this);
            }
        });
    });
    
    function validateField(field) {
        const fieldWrapper = field.closest('.field');
        let isValid = true;
        let errorMessage = '';
        
        const value = field.value.trim();
        const fieldName = field.name;
        
        // Required field check
        if (field.required && !value) {
            isValid = false;
            errorMessage = 'This field is required';
        }
        
        // Email validation
        if (field.type === 'email' && value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            }
        }
        
        // Phone validation (Canadian format)
        if (fieldName === 'phone' && value) {
            const digitsOnly = value.replace(/\D/g, '');
            if (digitsOnly.length < 10) {
                isValid = false;
                errorMessage = 'Please enter a valid phone number';
            }
        }
        
        // Postal code validation (Canadian format)
        if (fieldName.includes('postal_code') && value) {
            const postalRegex = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/;
            if (!postalRegex.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid postal code (e.g., M5V 1A1)';
            }
        }
        
        // Update UI
        const errorElem = fieldWrapper.querySelector('.field-error');
        if (isValid) {
            fieldWrapper.classList.remove('has-error');
            field.classList.remove('error');
            field.setAttribute('aria-invalid', 'false');
        } else {
            fieldWrapper.classList.add('has-error');
            field.classList.add('error');
            field.setAttribute('aria-invalid', 'true');
            if (errorElem && errorMessage) {
                errorElem.textContent = errorMessage;
            }
        }
        
        return isValid;
    }
    
    function getFormData() {
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });
        data.different_billing = document.getElementById('differentBilling').checked;
        return data;
    }
    
    {% if online_payments_enabled %}
    function showError(message) {
        const cardErrors = document.getElementById('card-errors');
        cardErrors.textContent = message;
        cardErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Get current totals for payment intent
    function getCurrentTotals() {
        const selectedShipping = shippingMethodInputs.find(input => input.checked);
        const shippingMethodId = selectedShipping ? selectedShipping.value : 'standard';
        const province = shippingStateSelect ? shippingStateSelect.value.trim().toUpperCase() : 'ON';
        return { shipping_method: shippingMethodId, province: province || 'ON' };
    }
    
    // Form submission with Stripe
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate all required fields first
        let isFormValid = true;
        const currentRequiredFields = form.querySelectorAll('[required]');
        
        currentRequiredFields.forEach(field => {
            if (!validateField(field)) {
                isFormValid = false;
            }
        });
        
        if (!isFormValid) {
            const firstError = form.querySelector('.field.has-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }
        
        // Prevent double-submission
        if (submitBtn.classList.contains('loading')) {
            return;
        }
        
        // Show loading state
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        
        try {
            // Step 1: Create PaymentIntent on server with current totals
            const totalsData = getCurrentTotals();
            const intentResponse = await fetch('{% url "core:create_payment_intent" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(totalsData)
            });
            
            const intentData = await intentResponse.json();
            
            if (intentData.error) {
                throw new Error(intentData.error);
            }
            
            // Show processing overlay
            processingOverlay.classList.add('show');
            
            // Step 2: Confirm payment with Stripe
            const { error, paymentIntent } = await stripe.confirmCardPayment(intentData.clientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: `${form.querySelector('[name="first_name"]').value} ${form.querySelector('[name="last_name"]').value}`,
                        email: form.querySelector('[name="email"]').value,
                        phone: form.querySelector('[name="phone"]').value,
                        address: {
                            city: form.querySelector('[name="shipping_city"]').value,
                            country: 'CA',
                            line1: form.querySelector('[name="shipping_address_1"]').value,
                            line2: form.querySelector('[name="shipping_address_2"]').value,
                            postal_code: form.querySelector('[name="shipping_postal_code"]').value,
                            state: form.querySelector('[name="shipping_state"]').value,
                        }
                    }
                }
            });
            
            if (error) {
                throw new Error(error.message);
            }
            
            if (paymentIntent.status === 'succeeded') {
                // Step 3: Create order on server
                const orderResponse = await fetch('{% url "core:process_payment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        payment_intent_id: paymentIntent.id,
                        form_data: getFormData()
                    })
                });
                
                const orderData = await orderResponse.json();
                
                if (orderData.success) {
                    // Redirect to confirmation page
                    window.location.href = orderData.redirect_url;
                } else {
                    throw new Error(orderData.error || 'Failed to create order');
                }
            }
            
        } catch (error) {
            console.error('Payment error:', error);
            processingOverlay.classList.remove('show');
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            showError(error.message || 'Payment failed. Please try again.');
        }
    });
    {% else %}
    // Form submission without Stripe (standard form submit)
    form.addEventListener('submit', function(e) {
        // Validate all required fields first
        let isFormValid = true;
        const currentRequiredFields = form.querySelectorAll('[required]');
        
        currentRequiredFields.forEach(field => {
            if (!validateField(field)) {
                isFormValid = false;
            }
        });
        
        if (!isFormValid) {
            e.preventDefault();
            const firstError = form.querySelector('.field.has-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }
        
        // Show loading state
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        processingOverlay.classList.add('show');
    });
    {% endif %}
    
    // Postal code formatting (shipping)
    const shippingPostalInput = form.querySelector('[name="shipping_postal_code"]');
    if (shippingPostalInput) {
        shippingPostalInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 3) {
                value = value.slice(0, 3) + ' ' + value.slice(3, 6);
            }
            e.target.value = value;
        });
    }
    
    // Postal code formatting (billing)
    const billingPostalInput = form.querySelector('[name="billing_postal_code"]');
    if (billingPostalInput) {
        billingPostalInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 3) {
                value = value.slice(0, 3) + ' ' + value.slice(3, 6);
            }
            e.target.value = value;
        });
    }
    
    // Phone formatting
    const phoneInput = form.querySelector('[name="phone"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = '(' + value;
                } else if (value.length <= 6) {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
                } else {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6, 10);
                }
            }
            e.target.value = value;
        });
    }
});

// ============================================
// CHECKOUT QUANTITY CONTROLS
// ============================================
async function updateCheckoutQty(itemId, delta) {
    const qtyDisplay = document.getElementById('qty-' + itemId);
    const priceDisplay = document.getElementById('price-' + itemId);
    const orderItem = document.querySelector('.order-item[data-item-id="' + itemId + '"]');
    const unitPrice = parseFloat(orderItem.dataset.unitPrice);
    const currentQty = parseInt(qtyDisplay.textContent);
    const newQty = currentQty + delta;
    
    if (newQty < 1) {
        removeCheckoutItem(itemId);
        return;
    }
    
    // Optimistic update
    qtyDisplay.textContent = newQty;
    priceDisplay.textContent = '$' + (newQty * unitPrice).toFixed(2);
    
    try {
        const response = await fetch('/cart/set-quantity-ajax/' + itemId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ quantity: newQty })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update header cart
            refreshCartDropdown();
            // Reload the page to update all totals correctly
            location.reload();
        } else {
            // Revert on error
            qtyDisplay.textContent = currentQty;
            priceDisplay.textContent = '$' + (currentQty * unitPrice).toFixed(2);
            alert(data.error || 'Could not update quantity');
        }
    } catch (error) {
        // Revert on error
        qtyDisplay.textContent = currentQty;
        priceDisplay.textContent = '$' + (currentQty * unitPrice).toFixed(2);
        console.error('Error updating quantity:', error);
    }
}

async function removeCheckoutItem(itemId) {
    if (!confirm('Remove this item from your cart?')) return;
    
    try {
        const response = await fetch('/cart/remove-ajax/' + itemId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // If cart is empty, redirect to cart page
            if (data.total_items === 0) {
                window.location.href = '{% url "core:cart" %}';
            } else {
                location.reload();
            }
        } else {
            alert(data.error || 'Could not remove item');
        }
    } catch (error) {
        console.error('Error removing item:', error);
    }
}

function refreshCartDropdown() {
    const dropdown = document.querySelector('.cart-dropdown');
    if (dropdown) {
        fetch('/cart/dropdown-html/')
            .then(r => r.text())
            .then(html => { dropdown.innerHTML = html; })
            .catch(e => console.error('Error refreshing cart:', e));
    }
}
</script>
{% endblock %}
