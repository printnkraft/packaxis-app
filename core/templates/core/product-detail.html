{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ product.title }} - {{ product.category.title }} | PackAxis Packaging{% endblock %}

{% block content %}
<!-- Product Detail Section -->
<section class="product-detail-section">
    <div class="container">
        <div class="product-detail-wrapper">
            <!-- Image Gallery (Left Side) -->
            <div class="product-gallery-left">
                <!-- Vertical Thumbnails -->
                {% if product_images|length > 1 %}
                <div class="thumbnail-gallery-vertical">
                    {% for img in product_images %}
                        <div class="thumbnail-item-vertical {% if forloop.first %}active{% endif %}" onclick="changeImage('{{ img.url }}', this)">
                            <img src="{{ img.url }}" alt="{{ img.alt }}">
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Main Image -->
                <div class="main-image-container-left">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.title }}" class="main-product-image" id="mainImage">
                    {% else %}
                        <div class="image-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Info (Right Side) -->
            <div class="product-info-right">
                <!-- Availability Badge -->
                <div class="availability-badge {% if product.track_inventory and product.stock_quantity <= 0 and not product.allow_backorder %}out-of-stock{% endif %}">
                    <span class="badge-dot"></span>
                    {% if product.track_inventory %}
                        {% if product.stock_quantity > 0 %}
                            <span>In Stock ({{ product.stock_quantity }} available)</span>
                        {% elif product.allow_backorder %}
                            <span>Available on Backorder</span>
                        {% else %}
                            <span>Out of Stock</span>
                        {% endif %}
                    {% else %}
                        <span>In Stock & Ready to Ship</span>
                    {% endif %}
                </div>
                
                <h1 class="product-title-main">{{ product.title }}</h1>
                
                <!-- SKU -->
                <div class="product-sku">
                    {% if product.sku %}
                    <span>SKU: {{ product.sku }}</span>
                    {% else %}
                    <span>SKU: {{ product.slug|upper }}</span>
                    {% endif %}
                </div>
                
                <!-- Pricing -->
                <div class="product-pricing-main">
                    {% if product.price %}
                        <span class="price-current">${{ product.price }}</span>
                        {% if product.compare_at_price and product.compare_at_price > product.price %}
                            <span class="price-compare">${{ product.compare_at_price }}</span>
                            <span class="price-discount">Save {{ product.discount_percentage }}%</span>
                        {% endif %}
                        {% if product.price_per %}
                            <span class="price-unit">{{ product.price_per }}</span>
                        {% endif %}
                    {% elif product.price_range %}
                        <span class="price-current">{{ product.price_range }}</span>
                        {% if product.minimum_order %}
                            <span class="price-unit">Min. {{ product.minimum_order }} pcs</span>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Size/Specifications Quick View -->
                {% if product.size or product.color %}
                <div class="product-options">
                    {% if product.size %}
                    <div class="option-group">
                        <label>Size</label>
                        <div class="option-value">{{ product.size }}</div>
                    </div>
                    {% endif %}
                    {% if product.color %}
                    <div class="option-group">
                        <label>Color</label>
                        <div class="option-value">{{ product.color }}</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Quantity Selector -->
                <form action="{% url 'core:add_to_cart' product.slug %}" method="POST" class="add-to-cart-form">
                    {% csrf_token %}
                    <div class="quantity-section">
                        <label>Quantity{% if product.case_quantity %} ({{ product.case_quantity }} per case){% endif %}</label>
                        <div class="quantity-selector">
                            <button type="button" class="qty-btn minus" onclick="decrementQty()">-</button>
                            <input type="number" name="quantity" id="quantity" value="{% if product.minimum_order %}{{ product.minimum_order }}{% else %}1{% endif %}" min="{% if product.minimum_order %}{{ product.minimum_order }}{% else %}1{% endif %}">
                            <button type="button" class="qty-btn plus" onclick="incrementQty()">+</button>
                        </div>
                        {% if product.minimum_order %}
                        <span class="min-order-note">Min. order: {{ product.minimum_order }} pcs</span>
                        {% endif %}
                    </div>

                    <!-- CTA Buttons -->
                    <div class="product-actions-main">
                        {% if product.price %}
                            <!-- E-commerce mode: Add to Cart -->
                            {% if product.is_in_stock or product.allow_backorder %}
                            <button type="submit" class="btn-add-cart">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="21" r="1"></circle>
                                    <circle cx="20" cy="21" r="1"></circle>
                                    <path d="m1 1 4 4 14 1-2 9H7"></path>
                                </svg>
                                Add to Cart
                            </button>
                            {% else %}
                            <button type="button" class="btn-add-cart out-of-stock" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                </svg>
                                Out of Stock
                            </button>
                            {% endif %}
                        {% else %}
                            <!-- Quote mode: Get a Quote -->
                            <a href="{% url 'core:quote_request' %}" class="btn-add-cart">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                </svg>
                                Get a Quote
                            </a>
                        {% endif %}
                        <a href="tel:+14164004747" class="btn-call" title="Call us now">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                        </a>
                    </div>
                </form>

                <!-- Trust Badges - Compact -->
                <div class="trust-badges-compact">
                    <div class="badge-compact">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="3" width="15" height="13" rx="2" ry="2"></rect>
                            <polyline points="16 8 20 8 23 11 23 16 20 16"></polyline>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                        <div>
                            <strong>Free Shipping</strong>
                            <span>Orders $2000+</span>
                        </div>
                    </div>
                    <div class="badge-compact">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            <polyline points="9 12 11 14 15 10"></polyline>
                        </svg>
                        <div>
                            <strong>Secure Checkout</strong>
                            <span>100% Protected</span>
                        </div>
                    </div>
                    <div class="badge-compact">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div>
                            <strong>Fast Response</strong>
                            <span>Within 24 hours</span>
                        </div>
                    </div>
                </div>
                
                <!-- Guarantee Banner -->
                <div class="guarantee-banner">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="7"></circle>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                    </svg>
                    <span><strong>Quality Guarantee</strong> â€” 100% satisfaction or we'll make it right</span>
                </div>
            </div>
        </div>
        
        <!-- Product Details Tabs (Full Width Below) -->
        <div class="product-tabs-section">
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab(event, 'description')">Description</button>
                <button class="tab-btn" onclick="switchTab(event, 'specifications')">Specifications</button>
                {% if features %}
                <button class="tab-btn" onclick="switchTab(event, 'features')">Key Features</button>
                {% endif %}
            </div>
            
            <div class="tabs-content">
                <!-- Description Tab -->
                <div id="description" class="tab-panel active">
                    {% if product.description %}
                        <p>{{ product.description }}</p>
                    {% else %}
                        <p>Premium quality packaging solution designed for your business needs. Contact us for detailed product information.</p>
                    {% endif %}
                </div>
                
                <!-- Specifications Tab -->
                <div id="specifications" class="tab-panel">
                    {% if specifications %}
                        <ul class="spec-list-tab">
                            {% for spec in specifications %}
                            <li>
                                <strong>{{ spec.label }}:</strong> {{ spec.value }}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Contact us for detailed specifications.</p>
                    {% endif %}
                </div>
                
                <!-- Features Tab -->
                {% if features %}
                <div id="features" class="tab-panel">
                    <ul class="features-list-tab">
                        {% for feature in features %}
                        <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>


<!-- Related Products -->
{% if related_products %}
<section class="related-products-section">
    <div class="container">
        <h2 class="section-title">You may also like</h2>
        <div class="related-products-grid">
            {% for related in related_products %}
            <a href="{% url 'core:product_detail' related.slug %}" class="related-product-card">
                {% if related.image %}
                    <div class="related-product-image">
                        <img src="{{ related.image.url }}" alt="{{ related.title }}">
                    </div>
                {% endif %}
                <div class="related-product-info">
                    <h3>{{ related.title }}</h3>
                    {% if related.price_range %}
                        <p class="related-price">{{ related.price_range }}</p>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<script>
// Image gallery switcher
function changeImage(imageUrl, thumbnail) {
    document.getElementById('mainImage').src = imageUrl;
    document.querySelectorAll('.thumbnail-item-vertical').forEach(item => {
        item.classList.remove('active');
    });
    thumbnail.classList.add('active');
}

// Quantity controls
function incrementQty() {
    const qtyInput = document.getElementById('quantity');
    qtyInput.value = parseInt(qtyInput.value) + 1;
}

function decrementQty() {
    const qtyInput = document.getElementById('quantity');
    const minQty = parseInt(qtyInput.min) || 1;
    if (parseInt(qtyInput.value) > minQty) {
        qtyInput.value = parseInt(qtyInput.value) - 1;
    }
}

// Tab switcher
function switchTab(event, tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// AJAX Add to Cart
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.add-to-cart-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"></circle>
                </svg>
                Adding...
            `;
            btn.style.opacity = '0.8';
            
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cart badge in header
                    const badge = document.querySelector('.cart-badge');
                    if (badge) {
                        badge.textContent = data.cart_total_items;
                        badge.style.transform = 'scale(1.3)';
                        setTimeout(() => badge.style.transform = 'scale(1)', 200);
                    } else {
                        const cartLink = document.querySelector('.nav-cart-link');
                        if (cartLink) {
                            const newBadge = document.createElement('span');
                            newBadge.className = 'cart-badge';
                            newBadge.textContent = data.cart_total_items;
                            cartLink.appendChild(newBadge);
                        }
                    }
                    
                    // Refresh the cart dropdown content
                    if (typeof refreshCartDropdown === 'function') {
                        refreshCartDropdown();
                    }
                    
                    // Show success state
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Added to Cart!
                    `;
                    btn.style.background = '#28a745';
                    btn.style.opacity = '1';
                    
                    // Show toast notification
                    showToast('Added to cart successfully!', 'success');
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    btn.innerHTML = originalText;
                    btn.style.opacity = '1';
                    btn.disabled = false;
                    showToast(data.message || 'Error adding to cart', 'error');
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
                btn.disabled = false;
                showToast('Error adding to cart', 'error');
            });
        });
    }
});

// Toast notification
function showToast(message, type) {
    // Remove existing toast
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${type === 'success' 
                ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'
                : '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'
            }
        </svg>
        <span>${message}</span>
        <a href="{% url 'core:cart' %}" class="toast-action">View Cart</a>
    `;
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Remove after 4 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
</script>

<style>
/* Toast Notification */
.toast-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    z-index: 9999;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
}

.toast-notification.show {
    transform: translateY(0);
    opacity: 1;
}

.toast-notification.success svg {
    color: #28a745;
}

.toast-notification.error svg {
    color: #dc3545;
}

.toast-notification span {
    font-size: 0.9375rem;
    font-weight: 500;
    color: #333;
}

.toast-action {
    margin-left: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border-radius: 50px;
    font-size: 0.8125rem;
    font-weight: 600;
    transition: background 0.2s;
}

.toast-action:hover {
    background: var(--secondary-color);
    color: white;
}

/* Spinner animation */
.spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@media (max-width: 600px) {
    .toast-notification {
        left: 20px;
        right: 20px;
        bottom: 10px;
    }
}
</style>
{% endblock %}
